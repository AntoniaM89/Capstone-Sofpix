<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Jugar Quiz - {{ quiz['titulo'] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style_jugar.css') }}">
</head>
<body>
    <!-- BotÃ³n Volver -->
    <a href="{{ url_for('quiz_controller.gestionar_quizzes') }}" class="back-button">
        <img src="{{ url_for('static', filename='icons/pencil_welcome.png') }}" alt="Volver">
        <span>Volver</span>
    </a>

    <h1>ğŸ² {{ quiz['titulo'] }}</h1>

    <div id="quiz-container">
        <div class="pregunta" id="pregunta"></div>
        <div class="imagen" id="imagen"></div>
        <div class="opciones" id="opciones"></div>
    </div>
    <button id="siguiente" style="display:none;">Siguiente</button> 

    <div id="resultado" style="display:none;">
        <h2>ğŸ‰ Â¡Quiz terminado!</h2>
        <div class="card-crema">
            <p id="puntaje"></p>
            <a href="{{ url_for('quiz_controller.gestionar_quizzes') }}" class="boton-volver">
                Volver a lista de quizzes
            </a>
        </div>
    </div>

    <script>
        let preguntas_juego = {{ preguntas | tojson | safe }};
        let index = 0;
        let puntaje = 0;

        function mostrarPregunta(i) {
            const p = preguntas_juego[i];
            document.getElementById("pregunta").innerText = p.PREGUNTA;

            const imgDiv = document.getElementById("imagen");
            imgDiv.innerHTML = "";

            const img = document.createElement("img");

            if (p.IMAGEN) {
                img.src = `/quiz/imagen_blob/${p.IMAGEN}`;
                img.alt = "Imagen de la pregunta";
            } else {
                img.src = "{{ url_for('static', filename='icons/question_background.png') }}";
                img.alt = "Imagen de placeholder";
            }
            
            imgDiv.appendChild(img);

            const opcionesDiv = document.getElementById("opciones");
            opcionesDiv.innerHTML = "";

            ["OPCION_A","OPCION_B","OPCION_C","OPCION_D"].forEach((key, idx) => {
                if (p[key]) {
                    const letra = ["A","B","C","D"][idx];
                    const btn = document.createElement("button");
                    btn.innerText = letra + ": " + p[key];
                    
                    btn.onclick = () => {
                        if (letra === p.RESPUESTA_CORRECTA) {
                            puntaje++;
                            btn.classList.add("correcta"); 
                        } else {
                            btn.classList.add("incorrecta");
                        }
                        Array.from(opcionesDiv.children).forEach(b => b.disabled = true);
                        document.getElementById("siguiente").style.display = "block";
                    };
                    opcionesDiv.appendChild(btn);
                }
            });
        }

        document.getElementById("siguiente").onclick = () => {
            index++;
            if (index < preguntas_juego.length) {
                mostrarPregunta(index);
                document.getElementById("siguiente").style.display = "none";
            } else {
                document.getElementById("quiz-container").style.display = "none";
                document.getElementById("resultado").style.display = "block";
                document.getElementById("puntaje").innerText = `Puntaje: ${puntaje} / ${preguntas_juego.length}`;
            }
        };

        // âœ… Validador dentro del recuadro blanco
        if (preguntas_juego.length === 0) {
            const contenedor = document.getElementById("quiz-container");
            contenedor.innerHTML = `
                <div class="mensaje-error">
                    âš ï¸ No hay preguntas en este quiz.<br>
                    Por favor agregue preguntas si desea jugar.
                </div>
            `;
            document.getElementById("siguiente").style.display = "none";
        } else {
            mostrarPregunta(index);
        }
    </script>

</body>
</html>
