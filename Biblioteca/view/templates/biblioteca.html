<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Biblioteca</title>
    <script>
        async function descargarArchivo(id) {
            if (window.pywebview) {
                // Estamos en la app de escritorio
                try {
                    const result = await window.pywebview.api.descargar(id);
                    if (result.ok) {
                        alert("‚úÖ Archivo descargado en: " + result.ruta);
                    } else {
                        alert("‚ùå Error al descargar el archivo");
                    }
                } catch (e) {
                    console.error("Error en descarga:", e);
                    alert("‚ùå No se pudo completar la descarga");
                }
            } else {
                // Modo navegador normal ‚Üí abrir ruta de descarga
                window.location.href = `/biblioteca/descargar/${id}`;
            }
        }
    </script>
</head>
<body>
    <h1>üìö Biblioteca</h1>

    <!-- Subida de archivo -->
    <form method="POST" enctype="multipart/form-data">
        <label>Archivo:</label>
        <input type="file" name="contenido" required>
        <br>
        <label>Carpeta:</label>
        <input type="text" name="carpeta" placeholder="Ej: Matem√°ticas">
        <br>
        <label>Profesor:</label>
        <select name="profesor_correo" required>
            <option value="">-- Selecciona un profesor --</option>
            {% for p in profesores %}
                <option value="{{ p[0] }}">{{ p[1] }} {{ p[2] }} ({{ p[0] }})</option>
            {% endfor %}
        </select>
        <br><br>
        <button type="submit">Subir</button>
    </form>

    <hr>

    <!-- Listado -->
    <h2>Archivos existentes</h2>
    <table border="1">
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>Fecha</th>
            <th>Profesor</th>
            <th>Carpeta</th>
            <th>Acciones</th>
        </tr>
        {% for a in archivos %}
        <tr>
            <td>{{ a[0] }}</td>
            <td>{{ a[1] }}</td>
            <td>{{ a[2] }}</td>
            <td>{{ a[3] }}</td>
            <td>{{ a[4] }}</td>
            <td>{{ a[5] }}</td>
            <td>
                <!-- Descargar -->
                <button type="button" onclick="descargarArchivo('{{ a[0] }}')">‚¨á Descargar</button>


            </td>
        </tr>
        {% endfor %}
    </table>

    <script>
    window.addEventListener('load', function () {
        document.body.tabIndex = 0;
        document.body.focus();

        document.addEventListener('keydown', function (e) {
        console.log('keydown', e.key, e.keyCode);
        if (e.key === 'Escape' || e.keyCode === 27) {
            if (window.history.length > 1) {
            window.history.back();
            } else {
            console.log('No history -> fallback to /');
            window.location.href = '/';
            }
        }
        });
    });
    </script>

</body>
</html>
